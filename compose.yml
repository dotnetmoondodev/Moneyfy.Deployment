services:
  frontend-webapp:
    image: moneyfy.azurecr.io/frontend.moneyfy.webapp:1.1.0
    ports:
      - 7103:8031
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8031
      - AppSettings:BackendServicesUrl=http://gateway-webapi:8010
      - AppSettings:Authority=${WebAuthority}
      - AppSettings:ClientId=${WebClientId}
      - AppSettings:Scope=${WebScope}
      - Authentication:Schemes:OpenIdConnect:ClientSecret=${WebClientSecret}
    volumes:
      - ${HOME}/.microsoft/usersecrets/:/root/.microsoft/usersecrets
      - ${HOME}/.aspnet/https:/root/.aspnet/https/

  gateway-webapi:
    image: moneyfy.azurecr.io/gateway.moneyfy.webapi:1.1.0
    ports:
      - 5281:8010
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8010
      - ApiSettings:Authority=${Authority}
      - ApiSettings:Audience=${Audience}
      - ApiSettings:MaxWindowSecondsTimeout=${MaxWindowSecondsTimeout}
      - ApiSettings:MaxPermitCounters=${MaxPermitCounters}
      - ReverseProxy:Routes:PaymentsRoute:Match:Path=${PaymentsRoute}
      - ReverseProxy:Routes:NotificationsRoute:Match:Path=${NotificationsRoute}
      - ReverseProxy:Routes:IncomesRoute:Match:Path=${IncomesRoute}
      - ReverseProxy:Routes:ExpensesRoute:Match:Path"${ExpensesRoute}
      - ReverseProxy:Clusters:PaymentsCluster:Destinations:Destination1:Address=http://payments-webapi:8029/payments
      - ReverseProxy:Clusters:NotificationsCluster:Destinations:Destination1:Address=http://notifications-webapi:8030/notifications
      - ReverseProxy:Clusters:IncomesCluster:Destinations:Destination1:Address=http://incomes-webapi:8028/incomes
      - ReverseProxy:Clusters:ExpensesCluster:Destinations:Destination1:Address=http://expenses-webapi:8027/expenses
    volumes:
      - ${HOME}/.microsoft/usersecrets/:/root/.microsoft/usersecrets
      - ${HOME}/.aspnet/https:/root/.aspnet/https/

  expenses-webapi:
    image: moneyfy.azurecr.io/expenses.moneyfy.webapi:1.1.0
    ports:
      - 5019:8027
    links:
      - mongo-db
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8027
      - ApiSettings:Authority=${Authority}
      - ApiSettings:Audience=${Audience}
      - ApiSettings:DBConnection=mongodb://${DBUserName}:${DBUserPass}@mongo-db:27017
    volumes:
      - ${HOME}/.microsoft/usersecrets/:/root/.microsoft/usersecrets
      - ${HOME}/.aspnet/https:/root/.aspnet/https/

  incomes-webapi:
    image: moneyfy.azurecr.io/incomes.moneyfy.webapi:1.1.0
    ports:
      - 5089:8028
    links:
      - mongo-db
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8028
      - ApiSettings:Authority=${Authority}
      - ApiSettings:Audience=${Audience}
      - ApiSettings:DBConnection=mongodb://${DBUserName}:${DBUserPass}@mongo-db:27017
    volumes:
      - ${HOME}/.microsoft/usersecrets/:/root/.microsoft/usersecrets
      - ${HOME}/.aspnet/https:/root/.aspnet/https/

  payments-webapi:
    image: moneyfy.azurecr.io/payments.moneyfy.webapi:1.1.0
    ports:
      - 5063:8029
    links:
      - mongo-db
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8029
      - ApiSettings:Authority=${Authority}
      - ApiSettings:Audience=${Audience}
      - ApiSettings:DBConnection=mongodb://${DBUserName}:${DBUserPass}@mongo-db:27017
    volumes:
      - ${HOME}/.microsoft/usersecrets/:/root/.microsoft/usersecrets
      - ${HOME}/.aspnet/https:/root/.aspnet/https/

  notifications-webapi:
    image: moneyfy.azurecr.io/notifications.moneyfy.webapi:1.1.0
    ports:
      - 5244:8030
    links:
      - mongo-db
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_HTTP_PORTS=8030
      - ApiSettings:Authority=${Authority}
      - ApiSettings:Audience=${Audience}
      - ApiSettings:DBConnection=mongodb://${DBUserName}:${DBUserPass}@mongo-db:27017
    volumes:
      - ${HOME}/.microsoft/usersecrets/:/root/.microsoft/usersecrets
      - ${HOME}/.aspnet/https:/root/.aspnet/https/

  mongo-db:
    image: mongo
    ports:
      - 27017:27017
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${DBUserName}
      - MONGO_INITDB_ROOT_PASSWORD=${DBUserPass}
    volumes:
      - mongodbdata:/data/db

volumes:
  mongodbdata:
